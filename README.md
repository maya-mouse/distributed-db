# LAB 4 — Потокова Обробка та Транзакційна Семантика (АЕС)

## Мета та Контекст

**Тема :** Атомні електростанції України (4 реакторні блоки)  

**Мета :** Розробити систему потокової обробки на базі Faust / Kafka Streams, що реалізує Hopping Windows для агрегації та Saga Pattern для забезпечення розподіленої транзакційної консистентності.  

**Завдання :** Реалізувати 3-крокову Saga для координації зміни навантаження реакторів (Load Following).  

**Підваріант (Б) :** Hopping Windows (5 хв / 1 хв крок) + Saga Pattern  

---

## Компоненти та Конфігурація

| Компонент | Технологія | Роль |
|-----------|------------|------|
| Потокова обробка | Faust (Python) | Імплементація Hopping Windows та керування Saga. |
| State Store | Memory Store (для ЛР) | Збереження проміжного стану агрегації (тотал потужності у вікнах). |
| Агрегація | Hopping Windows (5 хв / 1 хв) | Розрахунок ковзної суми потужності для виявлення відхилень. |
| Persistence Layer | Apache Cassandra | Довгострокове зберігання агрегатів та журналу аудиту Saga. |

---

## Структура Потокової Обробки

Проєкт реалізує агрегацію та транзакційний аудит.  

### 1. Реалізація Hopping Windows

Для кожного реактора обчислюється сума потужності за 5-хвилинний інтервал, що оновлюється кожну хвилину.  

**Місце для блоку коду:** Фрагмент Faust коду агрегації (Показати `.hopping(...)` та `.sum().events()`).

### 2. Схеми Cassandra (Persistence)

Дані зберігаються у двох основних таблицях для аналітики та аудиту:

| Таблиця | Призначення |
|---------|-------------|
| load_following_aggregates | Результат Hopping Windows для історичного аналізу. |
| saga_log | Журнал аудиту всіх кроків та компенсацій (для SNRIU). |

**Місце для перевірки:** Скріншот перевірки Cassandra (Результат запиту `SELECT * FROM saga_log LIMIT 5`).

---

## Результати Тестування Saga Pattern

Saga Pattern запускається, коли агрегована потужність реактора падає нижче 90% від номіналу (імітація потреби у корекції навантаження).  

### 1. Успішне Виконання Транзакції (Load Follow)

| Крок | Дія | Аудит |
|------|-----|-------|
| Крок 1 | Розрахунок нового режиму | `saga_log` (STARTED) |
| Крок 2 | Команда на переміщення керуючих стрижнів | Успіх |
| Крок 3 | Підтвердження досягнення планової потужності | `saga_log` (COMPLETED) |

**Місце для скріншота:** Лог `SAGA COMPLETED` (Повідомлення `--- SAGA STARTED... → --- SAGA COMPLETED...`).

### 2. Тестування Компенсації (Відкат)

У разі збою на Кроці 2 (імітація збою стрижнів), Saga виконує компенсацію.

| Збій | Компенсація | Аудит |
|------|------------|-------|
| Крок 2 (Error) | Фізичний збій переміщення стрижнів | `saga_log` (COMPENSATED) |
| Відкат | Надсилання команди на повернення до попереднього режиму | `saga_compensation_topic` |

**Місце для скріншота:** Лог спрацювання COMPENSATION (Повідомлення `ПОМИЛКА → [COMPENSATION] Відкат`).

---

## Висновки та Надійність

- **Hopping Window:** Агрегація ефективна для виявлення тривалих трендів падіння потужності.  
- **Saga Pattern:** Забезпечує надійність розподіленої операції. Навіть при збої фізичного обладнання (Крок 2), фінансова/регуляторна система не залишається в неконсистентному стані завдяки компенсуючій дії.  
- **Інтеграція:** Cassandra є ідеальним сховищем для аудит-трейлу (журналу Saga) та часових агрегатів.  
- **Exactly-Once Semantics:** Хоча Faust використовує At-Least-Once, Saga Pattern на рівні додатку забезпечує необхідну логічну консистентність для критичних енергетичних транзакцій.


